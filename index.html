<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Marc Finance Pro</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root {
    --bg: #0f172a;
    --card: #1e293b;
    --primary: #064e3b;
    --accent: #10b981;
    --red: #ef4444;
    --text: #f8fafc;
    --gray-light: #94a3b8;
}

body {
    margin: 0;
    font-family: 'Segoe UI', system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    padding-bottom: 40px;
}

.logo-container { perspective: 1000px; display: flex; justify-content: center; margin: 30px 0; }
.logo {
    font-size: 38px; font-weight: 800; color: var(--accent);
    text-transform: uppercase; letter-spacing: 2px;
    animation: rotate3D 6s linear infinite;
}

@keyframes rotate3D { 0% { transform: rotateY(0deg); } 100% { transform: rotateY(360deg); } }

/* LOCK SCREEN */
.lock-screen { position: fixed; inset: 0; background: var(--bg); z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
.lock-screen input { width: 100%; max-width: 250px; padding: 15px; border-radius: 12px; border: 1px solid #334155; background: var(--card); color: white; text-align: center; margin-bottom: 15px; }
.lock-screen button { width: 100%; max-width: 250px; padding: 15px; background: var(--accent); border: none; border-radius: 12px; font-weight: bold; cursor: pointer; }

.hidden { display: none !important; }
.container { max-width: 900px; margin: auto; padding: 15px; }

.card { background: var(--card); padding: 20px; border-radius: 20px; margin-bottom: 20px; }

.summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px; }
.summary-box { background: var(--card); padding: 15px; border-radius: 15px; text-align: center; }
.summary-box h3 { font-size: 11px; margin: 0; opacity: 0.7; text-transform: uppercase; }
.summary-box p { font-size: 15px; font-weight: bold; margin: 8px 0 0; }
.balance-text { color: var(--gray-light); }

form { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
input, select, button { padding: 12px; border-radius: 10px; border: 1px solid #334155; font-size: 14px; background: #0f172a; color: white; }
.full-w { grid-column: span 2; }
form button { background: var(--accent); color: var(--bg); font-weight: bold; border: none; }

/* FILTROS */
.filter-bar { display: flex; gap: 10px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
.filter-bar select, .filter-bar input { padding: 8px; font-size: 12px; flex-shrink: 0; }

.t-item { background: #33415555; padding: 12px; border-radius: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
.green { color: var(--accent); }
.red { color: var(--red); }

.chart-container { position: relative; height: 280px; margin: auto; }
</style>
</head>
<body>

<div class="lock-screen" id="lockScreen">
    <div class="logo">MARC FINANCE</div>
    <input type="password" id="passwordInput" placeholder="PIN de Acesso">
    <button onclick="checkPassword()">ENTRAR</button>
    <p id="errorMsg" class="red" style="margin-top:10px"></p>
</div>

<div id="mainContent" class="hidden">
    <div class="container">
        <div class="logo-container"><div class="logo">MARC FINANCE</div></div>

        <div class="summary-grid">
            <div class="summary-box"><h3>Entradas</h3><p id="totalGain" class="green">R$ 0,00</p></div>
            <div class="summary-box"><h3>Saídas</h3><p id="totalExpense" class="red">R$ 0,00</p></div>
            <div class="summary-box"><h3>Saldo Atual</h3><p id="balance" class="balance-text">R$ 0,00</p></div>
        </div>

        <div class="card">
            <h2 style="font-size: 16px; margin-top:0; text-align: center;">Distribuição Financeira (%)</h2>
            <div class="chart-container">
                <canvas id="financeChart"></canvas>
            </div>
        </div>

        <div class="card">
            <form id="form">
                <input type="date" id="date" required class="full-w">
                <input type="text" id="desc" placeholder="Descrição (Ex: Almoço)" required class="full-w">
                
                <select id="category" required>
                    <option value="" disabled selected>Categoria</option>
                    <option value="Comprar Mercado">Comprar Mercado</option>
                    <option value="Uber">Uber</option>
                    <option value="Pix P2P">Pix P2P</option>
                    <option value="Dinheiro">Dinheiro</option>
                    <option value="Lazer">Lazer</option>
                    <option value="Outros">Outros</option>
                </select>

                <select id="bank" required>
                    <option value="" disabled selected>Banco/Carteira</option>
                    <option value="Caixa">Caixa</option>
                    <option value="Bradesco">Bradesco</option>
                    <option value="Nubank">Nubank</option>
                    <option value="Sicredi">Sicredi</option>
                    <option value="Dinheiro">Dinheiro (Espécie)</option>
                </select>

                <select id="type">
                    <option value="gain">Ganho (+)</option>
                    <option value="expense">Despesa (-)</option>
                </select>
                <input type="number" step="0.01" id="amount" placeholder="Valor R$" required>
                
                <button type="submit" class="full-w">SALVAR TRANSAÇÃO</button>
            </form>
        </div>

        <div class="filter-bar">
            <select id="filterBank" onchange="applyFilters()">
                <option value="">Todos os Bancos</option>
                <option value="Caixa">Caixa</option>
                <option value="Bradesco">Bradesco</option>
                <option value="Nubank">Nubank</option>
                <option value="Sicredi">Sicredi</option>
                <option value="Dinheiro">Dinheiro</option>
            </select>
            <input type="month" id="filterMonth" onchange="applyFilters()">
        </div>

        <div id="transactionsList"></div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyAwoHA7RY9IRZOHIVTuiJJsQxAOCsND374",
    authDomain: "marcfinance-32a54.firebaseapp.com",
    projectId: "marcfinance-32a54",
    storageBucket: "marcfinance-32a54.firebasestorage.app",
    messagingSenderId: "927403672360",
    appId: "1:927403672360:web:f876e9d7be08325addc61d"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const PASSWORD = "071301";
let myChart = null;
let allTransactions = [];

window.checkPassword = () => {
    if(document.getElementById("passwordInput").value === PASSWORD){
        document.getElementById("lockScreen").classList.add("hidden");
        document.getElementById("mainContent").classList.remove("hidden");
        initApp();
    } else {
        document.getElementById("errorMsg").innerText = "Senha incorreta!";
    }
};

function initApp() {
    const q = query(collection(db, "transactions"), orderBy("date", "desc"));
    onSnapshot(q, (snapshot) => {
        allTransactions = [];
        snapshot.forEach(doc => allTransactions.push({ id: doc.id, ...doc.data() }));
        applyFilters();
    });
}

document.getElementById("form").onsubmit = async (e) => {
    e.preventDefault();
    await addDoc(collection(db, "transactions"), {
        date: document.getElementById("date").value,
        desc: document.getElementById("desc").value,
        category: document.getElementById("category").value,
        bank: document.getElementById("bank").value,
        type: document.getElementById("type").value,
        amount: parseFloat(document.getElementById("amount").value),
        timestamp: Date.now()
    });
    e.target.reset();
};

window.removeT = async (id) => {
    if(confirm("Deseja excluir esta transação?")) await deleteDoc(doc(db, "transactions", id));
};

window.applyFilters = () => {
    const bankF = document.getElementById("filterBank").value;
    const monthF = document.getElementById("filterMonth").value;

    const filtered = allTransactions.filter(t => {
        const matchBank = bankF === "" || t.bank === bankF;
        const matchMonth = monthF === "" || t.date.startsWith(monthF);
        return matchBank && matchMonth;
    });

    render(filtered);
};

function render(data) {
    const list = document.getElementById("transactionsList");
    list.innerHTML = "<h2 style='font-size:16px'>Histórico</h2>";
    
    let g = 0, e = 0;
    data.forEach(t => {
        if(t.type === "gain") g += t.amount; else e += t.amount;
        list.innerHTML += `
            <div class="t-item">
                <div>
                    <small style="opacity:0.6">${t.date} • ${t.bank}</small><br>
                    <strong>${t.desc}</strong><br>
                    <small style="color:var(--accent)">${t.category}</small>
                </div>
                <div style="text-align:right">
                    <span class="${t.type === 'gain' ? 'green' : 'red'}">
                        ${t.type === 'gain' ? '+' : '-'} R$ ${t.amount.toLocaleString('pt-BR', {minimumFractionDigits: 2})}
                    </span><br>
                    <button onclick="removeT('${t.id}')" style="background:none; border:none; color:grey; font-size:10px; cursor:pointer">Remover</button>
                </div>
            </div>`;
    });

    document.getElementById("totalGain").innerText = `R$ ${g.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
    document.getElementById("totalExpense").innerText = `R$ ${e.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
    document.getElementById("balance").innerText = `R$ ${(g - e).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;

    updateChart(g, e);
}

function updateChart(g, e) {
    const ctx = document.getElementById('financeChart').getContext('2d');
    const total = g + e;
    const pG = total > 0 ? ((g / total) * 100).toFixed(1) : 0;
    const pE = total > 0 ? ((e / total) * 100).toFixed(1) : 0;

    if(myChart) myChart.destroy();

    myChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: [`Entradas (${pG}%)`, `Saídas (${pE}%)`],
            datasets: [{
                data: [g, e],
                backgroundColor: ['#10b981', '#ef4444'],
                borderWidth: 0,
                hoverOffset: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom', labels: { color: 'white', padding: 20 } }
            },
            cutout: '70%'
        }
    });
}
</script>
</body>
</html>
